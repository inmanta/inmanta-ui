// Publish inmanta-ui as a python package to the internal devpi repository. This pipeline can build dev, next and stable releases.
pipeline {
  agent any

  parameters {
    choice(name: 'release_type', choices: ['dev', 'next', 'stable'], description: 'Indicate whether a dev, next or stable release should be build.')
  }

  options {
    disableConcurrentBuilds()
    checkoutToSubdirectory('inmanta-ui')
    skipDefaultCheckout()
  }

  stages {
    stage('Clear workspace and checkout source code') {
      steps {
        deleteDir()
        dir('inmanta-ui') {
          checkout scm
        }
      }
    }
    stage("Setup virtualenv"){
      steps{
        sh '''
          # Setup venv
          python3 -m venv ${WORKSPACE}/env
        '''
      }
    }
    stage("Publish") {
      steps {
        withCredentials([usernamePassword(credentialsId: 'devpi-user', passwordVariable: 'DEVPI_PASS', usernameVariable: 'DEVPI_USER')]) {
          sh '''
            source "${WORKSPACE}/env/bin/activate"
            make -C inmanta-ui upload-python-package RELEASE=${release_type}
          '''
        }
      }
    }
  }
}
